# echuu v2 - 优化说明

## 🎯 解决的核心问题

根据你的反馈，V1 版本存在以下问题：

1. **车轱辘话** - 10s前和10s后说的话几乎一样
2. **叙事不延展** - 没有完整的起承转合
3. **弹幕承接差** - 不能自然引导话题，复读SC/弹幕后不能沿着继续说

## ✅ V2 核心改进

### 1. 预生成完整剧本（100秒）

**旧版 V1**：
```python
# 只生成节点骨架
[
  {"stage": "Hook", "duration": 20, "hint": "引出话题"},
  {"stage": "Build-up", "duration": 40, "hint": "铺垫背景"},
  ...
]
# 实时生成台词 → 容易重复
```

**新版 V2**：
```python
# 预生成10-15句完整台词
[
  {
    "text": "那时候我刚到日本，穷得叮当响",
    "stage": "Build-up",
    "cost": 0.5,
    "key_info": ["留学日本", "经济困难"]  # 🔑 关键！
  },
  {
    "text": "室友是个富二代，冰箱里永远堆满零食",
    "stage": "Build-up",
    "cost": 0.6,
    "key_info": ["室友富二代", "零食多"]
  },
  ...
]
```

**效果**：
- ✅ 每句推进新信息，不会重复
- ✅ 有完整的起承转合
- ✅ 总长度约100秒，内容丰富

### 2. key_info 标注系统

每句台词的关键信息点，用于：

1. **追踪已说内容** - 避免重复
2. **匹配弹幕问题** - "室友生气吗？" → 搜索 key_info 包含"室友反应"
3. **判断承诺兑现** - 到达答案行时自动标记

### 3. 统一弹幕处理（相关性为王）

**优先级公式**：
```python
priority = base_score + relevance_bonus + sc_bonus
```

**实例对比**：

| 弹幕 | base | relevance | SC | priority | 结果 |
|------|------|-----------|----|---------| -----|
| "哈哈哈" | 0.15 | 0.0 | 0.0 | **0.15** | ❌ 不打断(cost=0.5) |
| "室友知道吗" | 0.3 | **+0.4** (高相关) | 0.0 | **0.7** | ✅ 打断！ |
| "[SC¥50] 主播多大" | 0.3 | 0.0 | 0.3 | **0.6** | ✅ 打断（SC加成） |
| "[SC¥50] 室友生气吗" | 0.3 | **+0.4** | 0.3 | **0.9** | ✅ 打断！高优先级 |

**关键洞察**：
- 高相关问题 (0.7) > 低相关SC¥50 (0.6)
- **相关性是最重要因素**，不是单纯看SC金额

### 4. 答案查找机制

当弹幕提问时：

```python
问题: "室友生气了吗？"
关键词: ["室友", "生气"]

查找流程:
1. 遍历剧本 key_info
2. 找到匹配: line[9].key_info = ["室友反应", "室友宽容", "没生气"]
3. 计算距离: 9 - 4 = 5句

决策:
if 距离 <= 3:
    action = "jump"  # 高优先级可以跳跃
elif 距离 > 3:
    action = "tease"  # 吊胃口 + 记录承诺
else:
    action = "improvise"  # 剧本里没有
```

### 5. 记忆系统

可视化展示AI记住了什么：

```
┌─────────────────────────────────────────────┐
│ 🧠 AI记忆状态                               │
├─────────────────────────────────────────────┤
│ 📖 剧本: [████████░░] 8/12 (Climax)         │
│ 💬 弹幕: 已回应3条, 待回答1个问题           │
│ 🤝 待兑现承诺:                              │
│    • 室友生不生气...                        │
│ 🎭 已提到:                                  │
│    ✓ 留学日本                               │
│    ✓ 经济困难                               │
│    ✓ 室友富二代                             │
└─────────────────────────────────────────────┘
```

### 6. 弹幕承接改进

**旧版**：
```
弹幕: "[SC¥50] 室友生气了吗"
回应: "哈哈这个问题问得好" [然后继续说无关内容]
```

**新版**：
```
弹幕: "[SC¥50] 室友生气了吗"

处理流程:
1. 复读: "诶有SC！有人问后来室友生气了吗，"
2. 查找答案: 在第9句（距离5句）
3. 策略: tease（吊胃口）
4. 回应: "这个问题太好了！先卖个关子，你们继续听就知道了，绝对出乎意料~"
5. 承接: "好，刚才说到，[继续当前台词]"
6. 记录承诺: {"content": "室友生不生气", "answer_at_line": 9}

到第9句时:
7. 检测到承诺兑现
8. 输出: "诶对了！刚才有人问室友生不生气对吧？答案来了——她说下次想吃直接说，我请你！"
```

## 📊 效果对比

| 维度 | V1 | V2 |
|------|----|----|
| **车轱辘话** | ❌ 严重 | ✅ 已解决（预生成完整剧本） |
| **叙事延展** | ❌ 模糊 | ✅ 10-15句完整故事 |
| **弹幕承接** | ❌ 生硬 | ✅ 复读+回应+自然过渡 |
| **话题引导** | ❌ 无法 | ✅ 高相关问题优先 |
| **承诺追踪** | ❌ 无 | ✅ 记忆系统追踪 |

## 🚀 使用方法

```python
# 1. 创建表演（预生成剧本）
state = engine_v2.create_performance(
    name="六螺",
    persona="活泼自嘲的主播",
    background="留学日本多年",
    topic="留学时偷吃室友腰果的故事",
    language="zh"
)

# 2. 运行表演（带弹幕）
results = engine_v2.run(
    state,
    danmaku_sim=[
        {"step": 1, "text": "哈哈哈"},
        {"step": 4, "text": "室友知道吗？"},
        {"step": 6, "text": "[SC ¥50] 室友生气了吗"},
    ],
    play_audio=True
)
```

## 🔧 核心文件位置

- `workflow/jupyter_notebook/echuu_with_tts.ipynb` - 完整实现
- Part 2: 数据结构（ScriptLine, Danmaku, PerformerMemory）
- Part 2.5: 弹幕处理器（DanmakuEvaluator, DanmakuHandler）
- Part 2.6: 剧本生成器（ScriptGeneratorV2）
- Part 2.7: 表演引擎（PerformerV2）
- Part 2.8: 完整引擎（EchuuEngineV2）
- Part 9: 测试代码

## 📝 关键设计思想

1. **预生成 > 实时生成** - 避免重复，保证叙事质量
2. **相关性为王** - 不是所有弹幕都平等，高相关问题 > 低相关SC
3. **记忆可视化** - 让用户看到AI"记住"了什么
4. **承诺必兑现** - 说了"等会告诉你"就必须记录并兑现
5. **自然承接** - 复读 → 回应 → 过渡语 → 继续剧本

## 🎯 下一步优化

1. LLM辅助回应生成（目前是模板）
2. 真正的跳跃实现（高优先级可以跳到答案行）
3. 承诺兑现时主动提醒
4. WebSocket接入真实弹幕

---

运行 notebook 查看完整效果！


